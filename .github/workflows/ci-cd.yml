name: CI-CD Pipeline

on:
  push:
    branches: [ main ]

permissions:
  security-events: write
  actions: read
  contents: read
  packages: write
  id-token: write

jobs:
  # ------------------------
  # CodeQL Security Scan
  # ------------------------
  codeql:
    name: Security Scan (CodeQL)
    uses: aba-enterprise/enterprise-ci-templates/.github/workflows/codeql.yml@main
    with:
      languages: "csharp"   # or "javascript-typescript,python" etc
    secrets: inherit

  # ------------------------
  # CI Stage (Build + Push to ECR)
  # ------------------------
  ci:
    needs: codeql
    name: Build and Push Image
    uses: aba-enterprise/enterprise-ci-templates/.github/workflows/ecr-ci-template.yml@main
    with:
      project-path: './dotnet-ecs-sample/dotnet-ecs-sample.csproj'
      dockerfile-path: './dotnet-ecs-sample/Dockerfile'
      image-name: 'dotnet-ecs-sample'
      ecr-repo: nonprodimagerepository
      aws-accountid: '707733857215'
    secrets: inherit

  # ------------------------
  # Deploy to Dev (auto)
  # ------------------------
  deploy-dev:
    needs: ci
    name: Deploy to ECS Dev
    uses: aba-enterprise/enterprise-ci-templates/.github/workflows/ecr-task-template.yml@main
    with:
      cluster-name: "test-ecs-cluster"
      task-family: "ecs-test-task"
      container-name: "ecs-test-container"
      ecr-repo: "nonprodimagerepository"
      aws-accountid: "707733857215"
    secrets: inherit

  ecs-service-dev:
    needs: deploy-dev
    uses: aba-enterprise/enterprise-ci-templates/.github/workflows/ecs-service-template.yml@main
    with:
      cluster-name: "test-ecs-cluster"
      service-name: "WeatherForecast_api"
      task-family: "ecs-test-task"
      subnets: "subnet-05741c5e17cae42e3,subnet-08a31fa8b5dec1cfa"
      security-groups: "sg-063ac0f34f2c86baa"
      desired-count: "1"
      aws-accountid: "707733857215"
      environment: "dev"
    secrets: inherit

  # ------------------------
  # Deploy to QA (requires approval)
  # ------------------------
  deploy-qa:
    needs: ecs-service-dev
    name: Deploy to ECS QA
    uses: aba-enterprise/enterprise-ci-templates/.github/workflows/ecr-task-template.yml@main
    with:
      cluster-name: "qa-ecs-cluster"
      task-family: "ecs-test-task"
      container-name: "ecs-test-container"
      ecr-repo: "nonprodimagerepository"
      aws-accountid: "707733857215"
    secrets: inherit

  ecs-service-qa:
    needs: deploy-qa
    uses: aba-enterprise/enterprise-ci-templates/.github/workflows/ecs-service-template.yml@main
    with:
      cluster-name: "qa-ecs-cluster"
      service-name: "WeatherForecast_api"
      task-family: "ecs-test-task"
      subnets: "subnet-xxx,subnet-yyy"
      security-groups: "sg-zzz"
      desired-count: "1"
      aws-accountid: "707733857215"
      environment: "qa"
    secrets: inherit

  # # ------------------------
  # # Deploy to Prod (requires approval)
  # # ------------------------
  # deploy-prod:
  #   needs: ecs-service-qa
  #   name: Deploy to ECS Prod
  #   uses: aba-enterprise/enterprise-ci-templates/.github/workflows/ecr-task-template.yml@main
  #   with:
  #     cluster-name: "prod-ecs-cluster"
  #     task-family: "ecs-test-task"
  #     container-name: "ecs-test-container"
  #     ecr-repo: "nonprodimagerepository"
  #     aws-accountid: "707733857215"
  #   secrets: inherit

  # ecs-service-prod:
  #   needs: deploy-prod
  #   uses: aba-enterprise/enterprise-ci-templates/.github/workflows/ecs-service-template.yml@main
  #   with:
  #     cluster-name: "prod-ecs-cluster"
  #     service-name: "WeatherForecast_api"
  #     task-family: "ecs-test-task"
  #     subnets: "subnet-aaa,subnet-bbb"
  #     security-groups: "sg-ccc"
  #     desired-count: "2"
  #     aws-accountid: "707733857215"
  #     environment: "prod"
  #   secrets: inherit

    